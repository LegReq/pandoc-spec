name: Pandoc Specification Builder
description: Sets up Pandoc and runs either a pre-defined pandoc-spec script in package.json or the pandoc-spec shell script.

inputs:
  include-repository:
    description: If true, includes node setup, repository checkout, and npm install. Default is false.
    required: false
  node-version:
    description: Version of node to be installed; ignored if include-repository is false. Default is environment-defined.
    required: false
  include-pages:
    description: If true, includes publication to GitHub Pages. Default is false.
    required: false
  pages-path:
    description: Path of the output directory containing the GitHub Pages content; ignored if include-pages is false. Default is "_site/".
    required: false
    # Default must match default for path in actions/upload-pages-artifact.
    default: "_site/"
  include-branches:
    description: If true, includes non-default branch publication to the "_branch/<branch_name>" path; ignored if include-pages is false.
    required: false
  default-branch:
    description: Default branch for include-branches to filter; ignored if include-branches is false. Default is "main".
    required: false
    default: "main"
  pages-archive:
    description: Pages archive name; ignored if include-branches is false. Default is "_pages". Temporary directory with this name will be created during build and ZIP file with this name will be published to the root.
    required: false
    default: "_pages"

runs:
  using: composite

  steps:
    - name: Setup node
      if: inputs.include-repository == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: https://registry.npmjs.org/

    - name: Checkout
      if: inputs.include-repository == 'true'
      uses: actions/checkout@v4

    - name: NPM install
      if: inputs.include-repository == 'true'
      shell: bash
      run: |
        npm install

    - name: Setup Pandoc
      uses: pandoc/actions/setup@v1

    - name: Build specification
      shell: bash
      run: |
        # Exit codes are handled by script.
        set +e
        
        if [[ -f package.json ]]
        then
          npm_scripts=$(npm run)
          
          if [[ $? -eq 0 ]]
          then
            if [[ "$npm_scripts" == "" ]]
            then
              echo "No scripts found."
              grep_result=1
            else
              # Check for package-defined build.
              echo "$npm_scripts" | grep -q "^  pandoc-spec-action$"
              grep_result=$?
            fi
          else
            # npm command failed.
            exit $?
          fi
        else
          # No package.json.
          grep_result=1
        fi
        
        if [[ -f $PWD/node_modules/.bin/pandoc-spec ]]
        then
          # Update path to include npm binary directory.
          PATH=$PATH:$PWD/node_modules/.bin
        else
          # Pandoc Specification Builder not installed in npm package; install globally.
          npm install @legreq/pandoc-spec --global
        fi
      
        if [[ $grep_result -eq 0 ]]
        then
          echo "Running pandoc-spec-action npm script"
          npm run pandoc-spec-action
        else
          echo "Running pandoc-spec shell script"
          pandoc-spec
        fi

    - name: Merge branches
      if: inputs.include-pages == 'true' && inputs.include-branches == 'true' && github.ref_type == 'branch'
      shell: bash
      run: |
        # Exit codes are handled by script.
        set +e
                
        pages_path="${{ inputs.pages-path }}"
        owner_name="${{ github.event.repository.owner.name }}"
        repository_name="${{ github.event.repository.name }}"
        default_branch="${{ inputs.default-branch }}"
        pages_archive="${{ inputs.pages-archive }}"
        branch="${{ github.ref_name }}"
        
        host_name=$(echo "$owner_name.github.io" | tr "[:upper:]" "[:lower:]")
        lower_repository_name=$(echo "$repository_name" | tr "[:upper:]" "[:lower:]")
        
        if [[ "$lower_repository_name" == "$host_name" ]]
        then
          echo "Repository is GitHub Pages default"
          pages_url="https://$host_name"
        else
          echo "Repository is not GitHub Pages default"
          pages_url="https://$host_name/$repository_name"
        fi
        
        # Get GitHub Pages archive.
        curl -fsSL "$pages_url/$pages_archive.zip" -o "$pages_archive.zip"
        
        if [[ $? -eq 0 ]]
        then
          echo "GitHub Pages archive downloaded"
          
          # Unzip will create the directory.
          unzip -qq "$pages_archive".zip -d "$pages_archive"
          rm "$pages_archive".zip
        else
          echo "No GitHub Pages archive downloaded"
        
          # Copy existing output as the root, creating directory if necessary.
          # If not the default branch, this will overwrite the root, but it's a one-time cost.  
          cp -r "$pages_path" "$pages_archive/"
        fi
        
        cd "$pages_archive"
        
        if [[ -d _branch ]]
        then
          echo "Directory _branch exists"
          
          cd _branch
          
          # Pipes spawn extra shells that don't share variables so write to file and then read from it.  
          git ls-remote --branches | grep -oE "[^/]+$" > remote_branches 2>/dev/null
          readarray -t remote_branches < remote_branches
          rm remote_branches
        
          find . -type d -print | grep -oE "[^./].*" | while read -r archive_branch
          do
            branch_matched=0
            
            for remote_branch in "${remote_branches[@]}"
            do
              if [[ "$remote_branch" == "$archive_branch" || "$remote_branch" == "$archive_branch/"* ]]
              then
                branch_matched=1
              fi
            done
            
            if [[ $branch_matched -eq 0 ]]
            then
              echo "Deleting stale branch $archive_branch"
        
              # Branch no longer exists; delete from GitHub Pages.
              rm -rf "$archive_branch"
            fi
          done
        
          cd ..
        else
          mkdir _branch
        fi
        
        if [[ "$branch" == "$default_branch" ]]
        then
          # Move entire _branch directory.
          mv _branch "../$pages_path"
        else
          # Remove previous branch content if it exists and replace it with newly generated content.
          rm -rf "_branch/$branch"
          mkdir -p "_branch/$branch"
          mv "../$pages_path"/* "_branch/$branch"
        
          # Move consolidated directory into place.
          mv * "../$pages_path"
        fi
        
        cd "../$pages_path"
        
        # Create archive and move into place for publication.
        zip -q -r ../"$pages_archive" .
        mv ../"$pages_archive".zip .
        
        echo "Pages archive created"
        
        cd ..

    - name: Configure GitHub Pages
      if: inputs.include-pages == 'true'
      uses: actions/configure-pages@v5

    - name: Upload pages directory
      if: inputs.include-pages == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ${{ inputs.pages-path }}

    - name: Deploy to GitHub Pages
      if: inputs.include-pages == 'true'
      uses: actions/deploy-pages@v4
